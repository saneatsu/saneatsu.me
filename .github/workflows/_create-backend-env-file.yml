name: ðŸ”‘ [Common] Create Backend env file

on:
  workflow_call:
    inputs:
      ENV:
        description: "Environment name (preview/production)"
        type: string
        required: true
    secrets:
      # Backendç”¨ç’°å¢ƒå¤‰æ•°
      TURSO_DATABASE_URL:
        required: true
      TURSO_AUTH_TOKEN:
        required: true
      CORS_ORIGIN:
        required: true
      ADMIN_EMAILS:
        required: true
      GEMINI_API_KEY:
        required: false # ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼ˆç¿»è¨³æ©Ÿèƒ½ã‚’ä½¿ã‚ãªã„å ´åˆã‚‚ã‚ã‚‹ï¼‰

env:
  ENV: ${{ inputs.ENV }}

jobs:
  # Backendç”¨ã® .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€Artifactã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
  create:
    runs-on: ubuntu-latest
    steps:
      - name: Create Backend .env file for ${{ env.ENV }}
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          CORS_ORIGIN: ${{ secrets.CORS_ORIGIN }}
          ADMIN_EMAILS: ${{ secrets.ADMIN_EMAILS }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          ENV_FILE=".env"
          echo "Creating Backend $ENV_FILE for ${{ env.ENV }} environment..."

          echo "TURSO_DATABASE_URL=$TURSO_DATABASE_URL" >> $ENV_FILE
          echo "TURSO_AUTH_TOKEN=$TURSO_AUTH_TOKEN" >> $ENV_FILE
          echo "CORS_ORIGIN=$CORS_ORIGIN" >> $ENV_FILE
          echo "ADMIN_EMAILS=$ADMIN_EMAILS" >> $ENV_FILE

          # GEMINI_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿è¿½åŠ 
          if [ ! -z "$GEMINI_API_KEY" ]; then
            echo "GEMINI_API_KEY=$GEMINI_API_KEY" >> $ENV_FILE
          fi

          echo "âœ… Created Backend $ENV_FILE with ${{ env.ENV }} configuration"

      - name: Upload .env as an artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-env-file-${{ env.ENV }}
          path: .env
          include-hidden-files: true
