name: üöÄ [Common] Deploy Backend

on:
  workflow_call:
    inputs:
      ENV:
        description: 'Environment name (preview/production)'
        type: string
        required: true
    secrets:
      CLOUDFLARE_ACCOUNT_ID:
        required: true
      CLOUDFLARE_API_TOKEN:
        required: true

env:
  ENV: ${{ inputs.ENV }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      statuses: write
      deployments: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download .env artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-env-file-${{ env.ENV }}
          path: apps/backend

      - name: Verify .env file
        run: |
          echo "üìÅ Files in apps/backend:"
          ls -la apps/backend/
          if [ -f apps/backend/.env ]; then
            echo "‚úÖ .env file exists"
            echo "üìÑ .env contents (masked):"
            sed 's/=.*/=***/' apps/backend/.env
          else
            echo "‚ùå .env file not found"
            exit 1
          fi

      - name: Build backend
        run: pnpm --filter @saneatsu/backend build

      - name: Deploy to Cloudflare Workers
        id: cloudflare-wrangler
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --env ${{ env.ENV }}
          workingDirectory: apps/backend

      - name: Add deployment URL as commit status
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.payload.pull_request?.head.sha ?? context.sha;
            const environment = '${{ env.ENV }}';
            const deploymentUrl = environment === 'production' 
              ? 'https://api.saneatsu.me' 
              : 'https://saneatsu-api-preview.w-saneatsu-e8c.workers.dev';
            
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              context: `Cloudflare Workers (${environment})`,
              description: "Access backend deployment",
              state: "success",
              sha,
              target_url: deploymentUrl,
            });